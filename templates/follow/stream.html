{% extends "base.html" %}

{% load display_sound %}

{% block title %}Stream{% endblock title %}

{% block content %}

    <script type="text/javascript">
        $(function () {

            $('select option[value="{{ select_value }}"]').attr("selected", true);

            if ('{{ select_value }}' != "specific_dates") {
                $("#date_pickers").hide();
                $("#date_submit").css("margin-left", "0");
            }
            else {
                $("#date_to").val('{{ date_to }}');
                $("#date_from").val('{{ date_from }}');
            }


            $("#time_lapse").change(function()Â {
                select_value = $("#time_lapse option:selected").val();
                if (select_value == "specific_dates") {
                    $("#date_pickers").show();
                }
                else {
                    $("#date_pickers").hide();
                }
            });

            $("#date_from").datepicker({
                showOn: "button",
                buttonImage: "/media/images/calendar.gif",
                // buttonImage: "{{ MEDIA_URL }}images/calendar.gif",
                buttonImageOnly: true,
                defaultDate: "-1w",
                dateFormat: "yy-mm-dd",
                changeYear: true,
                // changeMonth: true,
                onClose: function(selectedDate) {
                    $("#date_to").datepicker("option", "minDate", selectedDate);
                }
            });

            $("#date_to").datepicker({
                showOn: "button",
                buttonImage: "/media/images/calendar.gif",
                buttonImageOnly: true,
                dateFormat: "yy-mm-dd",
                // changeMonth: true,
                changeYear: true,
                maxDate: 0, // for today
                onClose: function(selectedDate) {
                    $("#date_from").datepicker("option", "maxDate", selectedDate);
                }
            });

        });
    </script>

    <h1>Stream</h1>

    <form action="." method="post">
        {% csrf_token %}
        <span id="stream_period">Select time period:</span>
        <select id="time_lapse" name="time_lapse">
            {% for key, value in SELECT_OPTIONS.items %}
                <option value="{{ key}}">{{ value }}</option>
            {% endfor %}

        </select>

        <div id="date_pickers">
            <label id="lbl_date_from" for="date_from">From:</label>
            <input id="date_from" name="date_from" type="text" placeholder="yyyy-mm-dd"/>
            <label id="lbl_date_to" for="date_to">To:</label>
            <input id="date_to" name="date_to" type="text" placeholder="yyyy-mm-dd"/>
        </div>

        {% comment %}<input type="submit" id="date_submit" style="margin-left:20px" value="Go!"/>{% endcomment %}
        <input type="submit" id="date_submit" value="Go!"/>
    </form>

{% comment %}
    {% if all_users %}

        <div id="stream_users" class="stream_box">

            <h3>Users</h3>

        {% for user, new_sounds_count in all_users %}
            <div class="active_user">
                <div class="active_user_info">
                    <a href="#{{ user.username }}"><img src="{{user.profile.locations.avatar.M.url}}" alt="avatar" /></a>

                    <div class="post_author">{{user.username}}</div>

                    <div class="people_user_info">
                        {{ new_sounds_count }} new sound{{ new_sounds_count|pluralize }}
                    </div>
                </div>
            <br class="clear" />
            </div>

        {% endfor %}
        </div>
        <br class="clear" />

    {% endif %}

    {% if all_tags %}

        <div id="stream_tags" class="stream_box">
            <h3>Tags</h3>

            {% for tags, new_sounds_count in all_tags %}
                <div class="active_user">
                    <div id="following_tags">
                        <div class="tag_group">
                            <ul class="tags" id="following_tags">
                                {% for tag in tags %}
                                    <li><a href="#{{ tags|join:"/" }}">{{ tag }}</a></li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                    <div class="people_user_info">{{ new_sounds_count }} new sound{{ new_sounds_count|pluralize }}</div>
                </div>
            {% endfor %}

            <br class="clear"/>

    {% endif %}
{% endcomment %}

    <div class="stream_box">

        <a id="new_sounds_users"></a>

        <h3>New sounds by users</h3>

        <a class="link-to-section" href="#new_sounds_tags">Go to new sounds by tag</a>

        {% if not users_sounds %}

            <div class="left">
                <p>No updates...</p>
            </div>

        {% else %}

            {% for user, sound_objs, more_url, more_count, new_count in users_sounds %}

                <div class="left">
                    {% for sound_obj in sound_objs %}
                        {% display_sound sound_obj.id %}
                    {% endfor %}
                    {% if more_count > 0 %}
                       <p><a href="{% url sounds-search %}{{ more_url }}">See all results ({{ more_count }} more)</a></p>
                    {% endif %}
                </div>

                <div class="right">
                    <a id="{{ user.0 }}" ></a>
                    {% include "accounts/active_user.html" %}
                    {% comment %}<a href="#" class="link-top">Go to Top</a>{% endcomment %}
                </div>

            {% endfor %}
        {% endif %}
        <br class="clear"/>
    </div>

    <div class="stream_box">
        <a id="new_sounds_tags"></a>
        <h3>New sounds by tags</h3>

        <a class="link-to-section" href="#new_sounds_users">Go to new sounds by users</a>

        {% if not tags_sounds %}

            <div class="left">
                <p>No updates...</p>
            </div>

        {% else %}

            {% for tags, sound_objs, more_url, more_count, new_count in tags_sounds %}

                <div class="left">
                    {% for sound_obj in sound_objs %}
                        {% display_sound sound_obj.id %}
                    {% endfor %}
                    {% if more_count > 0 %}
                       <p><a href="{% url sounds-search %}{{ more_url }}">See all results ({{ more_count }} more)</a></p>
                    {% endif %}
                </div>

                <div class="right" id="following_tags">
                    <a id="{{ tags|join:"/" }}"></a>
                    <div class="tag_group" onclick="location.href='{% url tags tags|join:"/" %}'">
                        <ul class="tags" id="following_tags">
                            {% for tag in tags %}
                                <li><a>{{ tag }}</a></li>
                            {% endfor %}
                        </ul>
                    </div>

                </div>

            {% endfor %}

        {% endif %}
        <br class="clear"/>
    </div>

{% endblock %}
