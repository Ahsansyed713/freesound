{% extends "base.html" %}

{% load util %}
{% load paginator %}
{% block head %}
{{ block.super }}
<style type="text/css" media="all">

</style>
<script type="text/javascript">
    function moderate(url) {
        $("#current_sound").load(url, function() { makePlayer('.player') });
    }

    function load_messages(url) {
        $("#moderation-ticket-messages").load(url+'messages/');
        $("#moderation-ticket-link").get(0).innerHTML = '<p><a href="'+url+'">see full ticket</a>';
    }

    function highlight_row_only(row_id) {
        $('.mod-selected-row').removeClass('mod-selected-row');
        $('#' + row_id).addClass('mod-selected-row');
    }

    var set_uploader_id = function(uploader_id) {
        loadUrl = '{% url "tickets-user-annotations" 0 %}'.replace('0', ''+uploader_id);
        $('#user-annotations-section').load(loadUrl);
    }
 

    $(document).ready(function() {
        {% if moderator_tickets_count %}

        // Checkbox select or unselect event
        $(".ticket-check").change(function(){
          updateSelectedTickets();
        });

        // Click on ticket at list
        $(".ticket-select").click(function(){
          var checked = $('#row_'+$(this).data('id')).find('.ticket-check');
          checked.attr('checked', !checked.attr('checked'))
          updateSelectedTickets();
          return false;
        }); 
       
        //Load initial selected values when page is loading
        var selected = $('#id_ticket').get(0).value;
        var selectedTickets = [];
        if (selected == '') {
          selectedTickets = ["{{page.object_list.0.id}}"];
        }else{
          selectedTickets = $('#id_ticket').get(0).value.split('|');
        }
        for (t in selectedTickets){
          $('#row_'+ selectedTickets[t]).find('.ticket-check').attr("checked", true);
        }
        updateSelectedTickets();
        
      {% endif %}
    });

    function updateSelectedTickets() {
      var selectedTickets = [];
      $('.mod-selected-row').removeClass('mod-selected-row');
      $('.ticket-check:checked').each(function() {
            selectedTickets.push($(this).data('id'));
            $('#row_'+$(this).data('id')).addClass('mod-selected-row');
          });
      if (selectedTickets.length == 1) {
        var ticketElem = $("#row_"+selectedTickets[0]);
        moderate(ticketElem.data('sound-url'));
        load_messages(ticketElem.data('messages-url'));
        highlight_row_only('row_'+selectedTickets[0]);
        set_uploader_id(ticketElem.data('sender-id'));
      }else{
        $('#current_sound').html('<p>'+selectedTickets.length+' Sounds Selected</p>')
        $('#moderation-ticket-messages').html('<p>'+selectedTickets.length+' Sounds Selected</p>')
        $('#user-annotations-section').html('')
        $('#moderation-ticket-link').html('')
      }
      $('#id_ticket').get(0).value=selectedTickets.join('|');
    }
    
    // Implementation of CSRF for ajax post requests
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            function getCookie(name) {
                var cookieValue = null;
                if (document.cookie && document.cookie != '') {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = jQuery.trim(cookies[i]);
                        // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
            }
            if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
                // Only send the token to relative URLs i.e. locally.
                xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
            }
        }
    });

</script>
{% endblock head %}


{% block title %}
    Moderation
{% endblock title %}

{% block content %}

    <!-- include permission checks here -->

    <div id="moderation-queue">

        <div id="moderation-queue-left">
            <h4>Assigned tickets {% if moderator_tickets_count > 0 %} ({{moderator_tickets_count}}) {% endif %}</h4>
            <br>
            {% if not moderator_tickets_count %}
                <p>You've finished all the sounds in your queue.
                <p>Back to <a href="{% url "tickets-moderation-home" %}">moderation home</a>
            {% endif %}
            <div id="assigned-tickets-table-wrapper">

                <table id="assigned-tickets-table">
                {% for ticket in page.object_list %}
                    {% if ticket.sound %}
                        <tr id="row_{{ ticket.id }}" class="alternate-row-{% cycle 'odd' 'even' %}"
                            data-sound-url="{% url "sound-display" ticket.sound.user.username ticket.sound.id %}"
                            data-messages-url="{% url "tickets-ticket" ticket.key %}" data-sender-id="{{ticket.sender.id}}">
                          <td><input type="checkbox" class="ticket-check" data-id="{{ticket.id}}"/> </td>
                          <td><a href="#" class="ticket-select" data-id="{{ticket.id}}">{{ticket.sound.original_filename|truncate_string:20}}</a></td>
                            <td>{{ticket.sender.username}}</td>
                            <td>{{ticket.created|date:"d/m/Y" }}</td>
                            <td>{{ticket.status|capfirst}}</td>
                        </tr>
                    {% endif %}
                {% endfor %}
                </table>

                {% if show_pagination %}
                    {% show_paginator paginator page current_page request "ticket" %}
                {% endif %}

            </div>

            <div id="user-annotations-section"></div>

        </div><!-- /#moderation-queue-left -->

        <div id="moderation-queue-right">

            <div id="moderation-form-wrapper">
                <h4>Moderate</h4>
                <br>
                <div id="moderation-form">
                    <form action="." method="post">{% csrf_token %}

                           <div id="moderation-decision-form">
                               {{ mod_sound_form.as_table }}
                           </div>
                            <div style="clear:both;">
                           {% include 'tickets/moderation_options.html' %}

                          <p>{{ msg_form.as_p }}
                        <br style="clear: both;">
                           <input type="submit" value="send" />

                       </form>
                </div>  
              
                <h4>Selected sound</h4>
                <div class="sample_player_small sound_list_moderation" id="current_sound">
                </div>

                <h4>Messages for sound</h4>
                <br>
                <div id="moderation-ticket-messages"></div>
                <div id="moderation-ticket-link"></div>
                
            </div>

            <div style="clear:both;"></div>

        </div><!-- /#moderation-queue-left -->
    </div><!-- /#moderation-queue -->
    <br style="clear: both;">


{% endblock content %}
