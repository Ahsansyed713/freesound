{% extends "sounds/_section.html" %}
{% load display_license_form %}

{% block title %}&quot;editing {{sound.original_filename}}{% endblock title %}

{% block head %}
{{ block.super }}
<script type="text/javascript" src="//maps.googleapis.com/maps/api/js?v=3&key={{google_api_key}}&sensor=false"></script>
{% endblock head %}

{% block section_content %}
<h1>Edit Sound</h1>

<h3>Sound description</h3>

<a id="description"></a>
<form method="post" action="#description">{% csrf_token %}
    {{description_form.as_p}}
    <input type="submit" name="submit" value="submit" />
</form>

<h3>Sound sources</h3>
<a id="edit_sources"></a>
<p>
    If you used other Freesound sounds in the process of creating
    this one you can mark the source sounds on the next page. If you do, other people
    can click through the remix graph and browse Freesound like this.
</p>
<p>
    <a href="{% url sound-edit-sources sound.user.username sound.id %}">Edit sound sources</a>
</p>

<h3>Sound license</h3>

<a id="license"></a>
<form method="post" action="#license">{% csrf_token %}
    {{ license_form.as_p }}
    <input type="submit" name="submit" value="submit" />
</form>
<br style="clear: both;" />

<h3>Pack</h3>

<a id="pack"></a>
<form method="post" action="#pack">{% csrf_token %}
    {{pack_form.as_p}}
    <input type="submit" name="submit" value="submit" />
</form>

<h3>Geotag</h3>

<a id="geotag"></a>
<form method="post" action="#geotag">{% csrf_token %}
 <p>Drag this map to set the geotag:</p>
    	<div id="map" style="width: 400px; height:400px; margin-bottom: 1em; float:left"></div>
    	<div style="float:ledt;margin-left:430px;">{{geotag_form.as_p}}</div>
        <br style="clear: both;" />
    <input type="submit" name="submit" value="submit" />
</form>

<h3>Delete</h3>
<a id="delete"></a>
<p>
    <a href="{% url sound-delete sound.user.username sound.id %}">Delete this sound</a>
</p>

<script type="text/javascript">

    var map = new google.maps.Map(
        document.getElementById('map'), {
          center: new google.maps.LatLng(23.885837699862005,21.796875),
          zoom: 2,
          mapTypeId: google.maps.MapTypeId.SATELLITE,
          scrollwheel: false,
          streetViewControl: false,
    });

    var initial_center = new google.maps.LatLng(23.885837699862005,21.796875)
    {% if sound.geotag %}
        initial_center = new google.maps.LatLng({{sound.geotag.lat}}, {{sound.geotag.lon}})
        map.setZoom({{sound.geotag.zoom}});
    {% endif %}
    map.setCenter(initial_center);

    var image = {
        url: "{{media_url}}/images/arrow.png",
        size: new google.maps.Size(25, 24),
        anchor: new google.maps.Point(0, 24)
    };

    var myLatLng = new google.maps.LatLng(initial_center);
    var centerMarker = new google.maps.Marker({
          position: myLatLng,
          map: map,
          icon: image
    });
    console.log(centerMarker)

    google.maps.event.addListener(map, "bounds_changed", updateAndAddCenter);

    updateAndAddCenter()

    function updateAndAddCenter()
    {
        var center = map.getCenter();
        var zoom = map.getZoom();
        // update form
        if (!$("#{{geotag_form.remove_geotag.auto_id}}").checked)
        {
            $("#{{geotag_form.lon.auto_id}}").val(center.lng());
            $("#{{geotag_form.lat.auto_id}}").val(center.lat());
            $("#{{geotag_form.zoom.auto_id}}").val(zoom);
        }
        centerMarker.setPosition(center);
    }


    $("#{{geotag_form.remove_geotag.auto_id}}").change(function (event) {
        if (this.checked)
        {
            $("#{{geotag_form.lon.auto_id}}").attr('disabled', 'disabled').val("");
            $("#{{geotag_form.lat.auto_id}}").attr('disabled', 'disabled').val("");
            $("#{{geotag_form.zoom.auto_id}}").attr('disabled', 'disabled').val("");
        }
        else
        {
            $("#{{geotag_form.lon.auto_id}}").attr('disabled', false);
            $("#{{geotag_form.lat.auto_id}}").attr('disabled', false);
            $("#{{geotag_form.zoom.auto_id}}").attr('disabled', false);
            updateAndAddCenter();
        }
    });

</script>
{% endblock section_content %}
