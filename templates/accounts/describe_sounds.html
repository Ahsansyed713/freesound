{% extends "base.html" %}
{% load display_license_form %}

{% block head %}
    {{ block.super }}
    <script src="{{media_url}}/js/jquery-ui-1.8.11.custom.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="//maps.googleapis.com/maps/api/js?v=3&key={{google_api_key}}&sensor=false"></script>
    <script>
        var maps = {};
        var centerMarkers = {};

        $(document).ready(function() {
            display_errors();
            for (var i=0; i<{{ sounds_per_round }}; i++){
                $('#sound-accordion-sound-'+i).hide();
            }
        });
        function display_errors() {
            if ($(".errorlist").length > 0) {
                if ($("#errormessage").length == 0) {
                    $("#describe_form").before("<div id='errormessage' class='errortag_message'>There are some errors or missing fields below. Please review files marked in red...</div>");
                }
            }
        }
        function toggleMapVisibility(n) {
            var wrapper = $('#gmap-wrapper-'+n);
            if(wrapper.is(':visible')) {
                $('#gmap-header-'+n).removeClass('.active-gmap');
                $('#gmap-header-text-'+n).text('Show Geotag map');
                wrapper.hide(500);
            } else {
                $('#gmap-header-'+n).addClass('.active-gmap');
                $('#gmap-header-text-'+n).text('Hide Geotag map');
                wrapper.show(500);
                if (!maps[n]){
                    init_map(n);
                }
            }
        }

        function toggleSound(n) {
            if ($('#sound-accordion-sound-'+n).is(':visible')) {
                $('#sound-accordion-sound-'+n).hide('fast');
            } else {
                $('#sound-accordion-sound-'+n).show('fast');
                if ($("#id_" + parseInt(n-1,10) + "-zoom").val()){
                    if (!maps[n]){
                        init_map(n);
                    }
                }
            }
        }

        function updateAndAddCenter(n)
        {
            var center = maps[parseInt(n,10)].getCenter();
            var zoom = maps[parseInt(n,10)].getZoom();

            if (!$("#id_" + parseInt(n-1,10) + "-remove_geotag").checked)
            {
                $("#id_" + parseInt(n-1,10) + "-lon").val(center.lng());
                $("#id_" + parseInt(n-1,10) + "-lat").val(center.lat());
                $("#id_" + parseInt(n-1,10) + "-zoom").val(zoom);
            }
            centerMarkers[parseInt(n,10)].setPosition(center);
        }

        function init_map(n) {
            var map = new google.maps.Map(
                document.getElementById('gmap' + parseInt(n,10)), {
                  center: new google.maps.LatLng(23.885837699862005,21.796875),
                  zoom: 2,
                  mapTypeId: google.maps.MapTypeId.SATELLITE,
                  scrollwheel: false,
                  streetViewControl: false,
            });

            var initial_center = new google.maps.LatLng(23.885837699862005,21.796875);
            var initial_zoom =  2;
            if ( ($("#id_" + parseInt(n-1,10) + "-zoom").val() != "") & ($("#id_" + parseInt(n-1,10) + "-lon").val() != "") & ($("#id_" + parseInt(n-1,10) + "-lat").val() != ""))
            {
                initial_center = new google.maps.LatLng( $("#id_" + parseInt(n-1,10) + "-lat").val() , $("#id_" + parseInt(n-1,10) + "-lon").val())
                initial_zoom = parseInt($("#id_" + parseInt(n-1,10) + "-zoom").val())
            }
            map.setCenter(initial_center);
            map.setZoom(initial_zoom);

            var image = {
                url: "{{media_url}}/images/arrow.png",
                size: new google.maps.Size(25, 24),
                anchor: new google.maps.Point(0, 24)
            };

            var centerMarker = new google.maps.Marker({
                  position: google.maps.LatLng(initial_center),
                  map: map,
                  icon: image
            });
            centerMarkers[parseInt(n,10)] = centerMarker;
            maps[parseInt(n,10)] = map;

            google.maps.event.addListener(maps[parseInt(n,10)], "bounds_changed", function(){
                updateAndAddCenter(n);
            });
        }

    </script>
    <style type="text/css">
        <!--
        .errortag {color: red;}
        -->
    </style>
{% endblock head %}


{% block title %}{{ block.super }}Describe - describe individual sounds{% endblock %}

{% block content %}
    <h1>Describe</h1>
    <h3>Describe individual sounds ({{request.session.describe_sounds_number}} left)</h3>
    <p>This is the last step in the describe process. If you've selected
        more than {{ sounds_per_round }} you will be asked to describe groups of {{ sounds_per_round }}
        sounds until all are done. In the list below you'll have to at least specify tags and
        a description for each of the uploaded sounds. <strong>Click on the sound filenames to display the
            form for describing each sound</strong>.

    <p>The license and the pack you've chosen in the previous steps will be applied to each
        of the files here. You can however change these settings for each individual file.

    <p>You are not required to specify a geolocation for each sound, but if the sound is a
        field-recording it's probably a good idea to specify the location.


    <form id="describe_form" action="." method="post">{% csrf_token %}
        <div id="sound-accordion-alternate">
            {% for form in forms %}

                <div onclick="toggleSound({{ forloop.counter }})" class="sound-accordion-sound-alternate-header{% if form.description.errors or form.geotag.errors or form.pack.errors or form.license.errors %}-errors{% endif %}" id="sound-accordion-sound-header-{{ forloop.counter }}">
                    {{ form.sound.name }}
                </div>

                <div class="sound-accordion-sound-alternate" id="sound-accordion-sound-{{ forloop.counter }}">
                    <h3>Tags and Description</h3>
                        {{ form.description.as_p }}

                    <h3>Geotag</h3>

                    <p id="gmap-header-{{forloop.counter}}">
                        <a onclick="toggleMapVisibility({{forloop.counter}});"><span id="gmap-header-text-{{forloop.counter}}">Show Geotag map</span></a>
                    </p>

                    <div class="gmap-wrapper" id="gmap-wrapper-{{forloop.counter}}">
                        <p>Drag this map to set a geotag:</p>
                        <div class="describe-gmap" id="gmap{{forloop.counter}}" style="width: 400px; height:300px;"></div>
                        <div class="describe-geotag-form">{{ form.geotag.as_p }}
                            <script type="text/javascript">

                                $("#{{form.geotag.remove_geotag.auto_id}}").change(function (event) {
                                    if (this.checked)
                                    {
                                        $("#{{form.geotag.lon.auto_id}}").attr('disabled', 'disabled').val("");
                                        $("#{{form.geotag.lat.auto_id}}").attr('disabled', 'disabled').val("");
                                        $("#{{form.geotag.zoom.auto_id}}").attr('disabled', 'disabled').val("");
                                    }
                                    else
                                    {
                                        $("#{{form.geotag.lon.auto_id}}").attr('disabled', false);
                                        $("#{{form.geotag.lat.auto_id}}").attr('disabled', false);
                                        $("#{{form.geotag.zoom.auto_id}}").attr('disabled', false);
                                        updateAndAddCenter({{forloop.counter}});
                                    }
                                });

                                if ($("#{{form.geotag.zoom.auto_id}}").val() != ""){
                                    $('#gmap-header-text-{{forloop.counter}}').text('Hide Geotag map');
                                }else{
                                    toggleMapVisibility({{forloop.counter}})
                                }

                            </script>
                        </div><br style="clear: both" />
                    </div>

                    <h3>Pack</h3>
                    {{ form.pack.as_p }}
                    <h3>License</h3>
                    {{ form.license.as_p }}
                    {% comment %}
            <!-- cannot include this right now because the remix sources form needs a sound object -->
            <h3>Remix Sources</h3>
                {{ form.remix.as_p }}
            {% endcomment %}
                    <br style="clear: both;" />
                </div><!-- .sound-accordion-sound -->

            {% endfor %}
        </div><!-- #sound-accordion -->


        <input type="submit" name="submit" value="submit and continue" id="submit-button"/>

    </form>

{% endblock %}



