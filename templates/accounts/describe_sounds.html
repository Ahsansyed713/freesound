{% extends "base.html" %}
{% load display_license_form %}

{% block head %}
	{{ block.super }}
	<script>
  		$(document).ready(function() {
  			$(".inner-accordion").accordion();
    		display_errors();
  		});
  		function display_errors() {
  	  		if ($(".errorlist").length > 0) {
  	  	  		if ($("#errormessage").length == 0) {
  	  	  			$("#describe_form").before("<div id='errormessage' class='errortag'>There are some errors or missing fields below. Please review your data...</div>");
  	  	  		}
	  	  	  	$(".inner-accordion, outer-accordion-div").has(".errorlist").prev().addClass("errortag");
				$(".inner-accordion, outer-accordion-div").has(".errorlist").prev().effect("pulsate", { times:2 }, 1000);
  	  	  		
  	  	  		$(".inner-accordion-div").has(".errorlist").prev().children("a").addClass("errortag");
				$(".inner-accordion-div").has(".errorlist").prev().effect("pulsate", { times:2 }, 1000);
  	  	  	}
  		}
    </script>
    <style type="text/css">
	<!--
		.errortag {color: red;}
	-->
	</style>
    <script src="{{media_url}}/js/jquery-ui-1.8.11.custom.min.js" type="text/javascript"></script>
    <script src="http://maps.google.com/maps?file=api&amp;v=2&amp;sensor=false&amp;key={{google_api_key}}" type="text/javascript"></script> 
{% endblock head %}



{% block title %}{{ block.super }}Describe - choose pack{% endblock %}



{% block content %}
<h1>Describe</h1>
<h3>Step 4 - describe individual sounds ({{request.session.describe_sounds_number}} left)</h3>
<p>This is the last step in the describe process. If you've selected 
   more than {{ sounds_per_round }} you will be asked to describe {{ sounds_per_round }}
   sounds until all are done. In the accordion below you'll have to at least specify tags and
   a description for each of the uploaded sounds. Please make them as specific and descriptive
   as humanly possible!
   
<p>The license and the pack you've chosen in the previous steps will be applied to each
   of the files here. You can however change these settings for each individual file.
   
<p>You are not required to specify a geolocation for each sound, but if the sound is a 
   field-recording it's probably a good idea to specify the location.  

	<form id="describe_form" action="." method="post">{% csrf_token %}
	{% for form in forms %}
		<h3>{{ form.sound.name }}</h3>
		<div class="inner-accordion outer-accordion-div">
	    	<h4><a href="#">Tags and Description</a></h4>
	    	<div class="inner-accordion-div">
	    		{{ form.description.as_p }}
	    	</div>
	    	<h4><a href="#">Geotag</a></h4>
	    	<div class="inner-accordion-div">
	    		<div class="describe-gmap" id="gmap{{forloop.counter}}" style="width: 400px; height:300px;"></div>
	    		<div class="describe-geotag-form">{{ form.geotag.as_p }}</div>
	    		<script type="text/javascript">
				    var map{{forloop.counter}} = new GMap2($("#gmap{{forloop.counter}}").get(0));
				    
				    var initialCenter = new GLatLng(23.885837699862005,21.796875);
				    var initialZoom = 2;
				
				    map{{forloop.counter}}.setCenter(initialCenter, initialZoom);
				    
				    map{{forloop.counter}}.setMapType( G_HYBRID_MAP );
				 	map{{forloop.counter}}.disableScrollWheelZoom();
				    map{{forloop.counter}}.enableContinuousZoom();
				    map{{forloop.counter}}.addControl(new GSmallMapControl());
				    map{{forloop.counter}}.addControl(new GMapTypeControl());
				    
				    var centerIcon = new GIcon();
				    centerIcon.image = "http://www.freesound.org/geotagging/arrow.png";
				    centerIcon.iconSize = new GSize(25, 24);
				    centerIcon.shadowSize = new GSize(0, 0);
				    centerIcon.iconAnchor = new GPoint(0, 24);
				    centerIcon.infoWindowAnchor = new GPoint(25, 0);
				    
				    var centerMarker{{forloop.counter}} = new GMarker(initialCenter, centerIcon);
				    map{{forloop.counter}}.addOverlay(centerMarker{{forloop.counter}});
				
				    GEvent.addListener(map{{forloop.counter}}, "move", updateAndAddCenter{{forloop.counter}});
				
				    // updateAndAddCenter{{forloop.counter}}()
				    
				    firstUpdate{{forloop.counter}}(); 
				    function firstUpdate{{forloop.counter}}() {
					    // if values are set
				        if ($("#{{form.geotag.lon.auto_id}}").val()
						        && !$("#{{form.geotag.remove_geotag.auto_id}}").checked) 
				        {
						    var lat = $("#{{form.geotag.lat.auto_id}}").val();
						    var lng = $("#{{form.geotag.lon.auto_id}}").val();
						    var latlng = new GLatLng(lat,lng);
						    var zoom = parseInt($("#{{form.geotag.zoom.auto_id}}").val());
						    centerMarker{{forloop.counter}}.setLatLng(latlng);
						    map{{forloop.counter}}.setCenter(latlng, zoom);
						}
					}
					function updateAndAddCenter{{forloop.counter}}()
				    {
				        var center = map{{forloop.counter}}.getCenter();
				        var zoom = map{{forloop.counter}}.getZoom();
				        // update form
				        if (!$("#{{form.geotag.remove_geotag.auto_id}}").checked)
				        {
			            	$("#{{form.geotag.lon.auto_id}}").val(center.lng());
					       	$("#{{form.geotag.lat.auto_id}}").val(center.lat());
					       	$("#{{form.geotag.zoom.auto_id}}").val(zoom);
				        }
				        centerMarker{{forloop.counter}}.setLatLng(center);
				    }
				    $("#{{form.geotag.remove_geotag.auto_id}}").change(function (event) {
				        if (this.checked)
				        {
				            $("#{{form.geotag.lon.auto_id}}").attr('disabled', 'disabled').val("");
				            $("#{{form.geotag.lat.auto_id}}").attr('disabled', 'disabled').val("");
				            $("#{{form.geotag.zoom.auto_id}}").attr('disabled', 'disabled').val("");
				        }
				        else
				        {
				            $("#{{form.geotag.lon.auto_id}}").attr('disabled', false);
				            $("#{{form.geotag.lat.auto_id}}").attr('disabled', false);
				            $("#{{form.geotag.zoom.auto_id}}").attr('disabled', false);
				            updateAndAddCenter{{forloop.counter}}();
				        }
				    });
				</script>
				<div id="test"></div>
	    	</div>
	    	<h4><a href="#">Pack</a></h4>
	    	<div class="inner-accordion-div">
	    		{{ form.pack.as_p }}
	    	</div>
	    	<h4><a href="#">License</a></h4>
	    	<div class="inner-accordion-div">
	    		{% display_license_form form.license %}
	    	</div>
	    	{% comment %}
	    	<!-- cannot include this right now because the remix sources form needs a sound object --> 
	    	<h4><a href="#">Remix Sources</a></h4>
	    	<div class="inner-accordion-div">
	    		{{ form.remix.as_p }}
	    	</div>
	    	{% endcomment %}
		</div>
	{% endfor %}

	<input type="submit" name="submit" value="submit and continue" id="submit-button"/>
	
	</form>

{% endblock %}