{% extends "base.html" %}
{% load display_license_form %}

{% block title %}{{ block.super }}Describe - Bulk Describe Sounds{% endblock %}

{% block content %}

<h1>Bulk Describe Sounds</h1>

{% if bulk.progress_type == 'N' %}
    <h3>Validating CSV file "{{ bulk.original_csv_filename }}"...</h3>
    <p>
        The uploaded CSV file has not yet been validated. If there are many sounds to be described, this process
        could take a few minutes. This page will reload automatically when CSV validation has fininshed.
    </p>
    <script>
        setTimeout(function(){ window.location.reload(1); }, 5000);
    </script>

{% elif bulk.progress_type == 'V' %}
    <h3>Validation results of the CSV file "{{ bulk.original_csv_filename }}"</h3>
    {% if global_errors %}
        <p>We have encountered some <b>major errors</b> when validating your CSV file:</p>
        <ul>
        {% for error in global_errors %}
            <li>{{ error }}</li>
        {% endfor %}
         </ul>
    {% endif %}

    {% if lines_failed_validation %}
        <p>
            The following <b>{{ lines_failed_validation|length }} sound{{ lines_failed_validation|pluralize }}
            ha{{ lines_failed_validation|pluralize:"s,ve" }} failed validation</b> and are not going to be added
            to Freesound if you continue now with the bulk describe process. Specific errors are maked in red in the
            following table:
        </p>
        <table class="csv-validation-table">
        <thead>
            <tr><th>#</th><th>Audio filename</th><th>Name</th><th>Tags</th><th>Geotag</th><th>Description</th><th>License</th><th>Pack</th></tr>
        </thead>
        <tbody>
            {% for line, line_no in lines_failed_validation %}
                <tr><td>{{ line_no }}</td>
                {% for value, error in line %}
                    <td {% if error %}style="background-color: rgba(255,64,60,0.65)"{% endif %}>{% if error %}
                        <a href="#" class="icon warning_icon" title="{{ error }}"></a>{% endif %}{{ value }}</td>
                {% endfor %}
                </tr>
            {% endfor %}
        </tbody>
        </table>

    {% endif %}

    {% if lines_validated_ok %}
        <p>
            The following <b>{{ lines_validated_ok|length }} sound{{ lines_validated_ok|length|pluralize }}
            ha{{ lines_validated_ok|pluralize:"s,ve" }} validated correctly</b> and will be described and added to
            Freesound with the metadata shown in the following table:
        </p>
        <table class="csv-validation-table">
        <thead>
            <tr><th>#</th><th>Audio filename</th><th>Name</th><th>Tags</th><th>Geotag</th><th>Description</th><th>License</th><th>Pack</th></tr>
        </thead>
        <tbody>
            {% for line, line_no in lines_validated_ok %}
                <tr><td>{{ line_no }}</td>
                {% for value in line %}
                    <td>{{ value }}</td>
                {% endfor %}
                </tr>
            {% endfor %}
        </tbody>
        </table>
    {% endif %}

    <form action="{% url "accounts-bulk-describe" bulk.id %}" method="GET">
        <input id="hidden_action" type="hidden" name="action" value="" />
        <input style="float:left;" type="submit" onclick="$('#hidden_action').attr('value', 'delete');" value="Delete this CSV file and upload a new one" />
        <input style="float:right;" type="submit" onclick="$('#hidden_action').attr('value', 'start');" value="Continue and add the {{ lines_validated_ok|length }} valid sound{{ lines_validated_ok|length|pluralize }} to Freesound"
            {% if not lines_validated_ok|length %}disabled="disabled"{% endif %}/>
        <br style="clear:both;"/>
    </form>

{% elif bulk.progress_type == 'S' or bulk.progress_type == 'F' %}
    <h3>Your {{ lines_validated_ok|length }} sounds are being described and processed</h3>
    <p>
        Congratulations! The sounds for this bulk description process are being described and processed. This is the
        current status of the process:
    </p>
    {% with bulk.get_description_progress_info as progress_info %}
        <ul>
            <li>Sounds successfully described: {{ progress_info.sound_ids_ok|length }}</li>
            {% if progress_info.sound_errors %}
            <li>Failed rows: {{ progress_info.sound_errors|length }}</li>
            <ul>
                {% for line_no, error in progress_info.sound_errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            </ul>
            {% endif %}
        </ul>
    {% endwith %}
    <p>
        For more details, please check the status of your sound uploads in the <a href="{% url "accounts-pending" %}">pending
        uploads</a> page or in your <a href="{% url "accounts-home" %}">home</a> page.
    </p>
{% endif %}

{% endblock %}
