<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE normalizer SYSTEM "normalizer.dtd">
<!--+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->
<!--Freesound is (c) MUSIC TECHNOLOGY GROUP, UNIVERSITAT POMPEU FABRA -->
<!-- ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->
<!--Freesound is free software: you can redistribute it and/or modify -->
<!--it under the terms of the GNU Affero General Public License as    -->
<!--published by the Free Software Foundation, either version 3 of the-->
<!--License, or (at your option) any later version.-->
<!--+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
<!--Freesound is distributed in the hope that it will be useful,-->
<!--but WITHOUT ANY WARRANTY; without even the implied warranty of-->
<!--MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the-->
<!--GNU Affero General Public License for more details.-->
<!---->
<!--You should have received a copy of the GNU Affero General Public License-->
<!--along with this program.  If not, see <http://www.gnu.org/licenses/>. -->
<!---->
<!--Authors:  Dara Dabiri                                              -->
<!--See AUTHORS file.-->

<normalizer name="clickusage"
            version="0.99"
            unicode="yes"
            ignorecase="yes"
            matchtype="match"
            appliedTo="raw">
    <tagTypes>
        <tagType name="cuTimeStamp" type="basestring">
            <regexp>\[\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3}\]</regexp>
        </tagType>
	<tagType name="cuClickType" type="basestring">
	    <regexp>(?:soundpreview)|(?:sounddownload)|(?:packdownload)</regexp>
	</tagType>
    </tagTypes>
    <callbacks>
	<callback name="decodecuTimeStamp">
timestamp, milliseconds = value.strip('[]').split(',', 1)
newdate = datetime(int(timestamp[:4]),
                   int(timestamp[5:7]),
                   int(timestamp[8:10]),
                   int(timestamp[11:13]),
                   int(timestamp[14:16]),
                   int(timestamp[17:19]))
log["date"] = newdate.replace(microsecond = int(milliseconds) * 1000 )
        </callback>
    </callbacks>
    <patterns>
	<pattern name="CLICK-LOG">
	    <text>TIMESTAMP # INFO    # CLICK_TYPE : AUTHENTICATED_SESSION_KEY : SEARCHTIME_SESSION_KEY : SOUND_ID</text>
	    <tags>
		<tag name="__date" tagType="cuTimeStamp">
		    <substitute>TIMESTAMP</substitute>
		    <callbacks>
			<callback>decodecuTimeStamp</callback>
		    </callbacks>
		</tag>
		<tag name="click_type" tagType="cuClickType">
		    <substitute>CLICK_TYPE</substitute>
		</tag>
		<tag name="authenticated_session_key" tagType="Anything">
		    <substitute>AUTHENTICATED_SESSION_KEY</substitute>
		</tag>
		<tag name="searchtime_session_key" tagType="Anything">
		    <substitute>SEARCHTIME_SESSION_KEY</substitute>
		</tag>
		<tag name="sound_id" tagType="Integer">
		    <substitute>SOUND_ID</substitute>
		</tag>
	    </tags>
	    <examples>
		<example>
		    <text>[2013-04-17 13:49:03,671] # INFO    # sounddownload : 1ccff2a2f23e672a96091b04dbc2d0c1 : 1ccff2a2f23e672a96091b04dbc2d0c1 : 38551</text>
		    <expectedTags>
			<expectedTag name="click_type">sounddownload</expectedTag>
			<expectedTag name="authenticated_session_key">1ccff2a2f23e672a96091b04dbc2d0c1</expectedTag>
			<expectedTag name="searchtime_session_key">1ccff2a2f23e672a96091b04dbc2d0c1</expectedTag>
			<expectedTag name="sound_id">38551</expectedTag>
		    </expectedTags>
		</example>
	    </examples>
	</pattern>
        <pattern name="QUERY-LOG">
            <text>TIMESTAMP # INFO    # QUERY : FULL_REQUEST : SEARCHTIME_SESSION_KEY : SOUND_IDS : CURRENT_PAGE</text>
            <tags>
                <tag name="__date" tagType="cuTimeStamp">
                    <substitute>TIMESTAMP</substitute>
                    <callbacks>
                        <callback>decodecuTimeStamp</callback>
                    </callbacks>
                </tag>
                <tag name="full_request" tagType="Anything">
                    <substitute>FULL_REQUEST</substitute>
                </tag>
                <tag name="searchtime_session_key" tagType="Anything">
                    <substitute>SEARCHTIME_SESSION_KEY</substitute>
                </tag>
                <tag name="sound_ids" tagType="Anything">
                    <substitute>SOUND_IDS</substitute>
                </tag>
		<tag name="current_page" tagType="Integer">
		    <substitute>CURRENT_PAGE</substitute>
		</tag>
            </tags>
            <examples>
                <example>
                     <text>[2013-04-17 13:49:13,007] # INFO    # QUERY : /search/?q=piano&amp;page=2 : 1ccff2a2f23e672a96091b04dbc2d0c1 : [38551, 108935, 18331, 12693, 68448, 53767, 31955, 46220, 104025, 11669, 121079, 121078, 121077, 104182, 104181] : 2</text>
                     <expectedTags>
                          <expectedTag name="full_request">/search/?q=piano&amp;page=2</expectedTag>
                          <expectedTag name="searchtime_session_key">1ccff2a2f23e672a96091b04dbc2d0c1</expectedTag>
                          <expectedTag name="sound_ids">[38551, 108935, 18331, 12693, 68448, 53767, 31955, 46220, 104025, 11669, 121079, 121078, 121077, 104182, 104181]</expectedTag>
			  <expectedTag name="current_page">2</expectedTag>
                     </expectedTags>
                </example>
            </examples>
        </pattern>
    </patterns>
</normalizer>
